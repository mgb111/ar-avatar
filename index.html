<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Talking Avatar Example</title>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.180.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.180.0/examples/jsm/",
      "talkinghead": "https://cdn.jsdelivr.net/gh/met4citizen/TalkingHead@1.6.0/modules/talkinghead.mjs",
      "headtts": "https://cdn.jsdelivr.net/npm/@met4citizen/headtts@0.2.1/+esm"
    }
  }
  </script>

  <style>
    body { margin: 0; font-family: system-ui, sans-serif; background: #f3f4f6; }
    #avatar { width: 100vw; height: 100vh; position: relative; overflow: hidden; }
    #controls {
      position: absolute; left: 16px; top: 16px; z-index: 40;
      background: rgba(0,0,0,0.5); color: white; padding: 10px; border-radius: 8px;
    }
    button { padding: 8px 12px; cursor: pointer; }
    p { margin: 8px 0 0 0; font-size: 13px; color: #fff; }
  </style>
</head>
<body>
  <div id="avatar"></div>

  <div id="controls">
    <button id="init-button">Load Avatar</button>
    <button id="speak-button" disabled>Play Introduction</button>
    <p id="status">Status: Waiting for user action</p>
  </div>

  <script type="module">
    import { TalkingHead } from 'talkinghead';
    import { HeadTTS } from 'headtts';

    const nodeAvatar = document.getElementById('avatar');
    const statusEl = document.getElementById('status');
    const initBtn = document.getElementById('init-button');
    const speakBtn = document.getElementById('speak-button');

    let head = null;
    let headtts = null;
    const myPredefinedScript = "Hello, this talking avatar is now working correctly.";

    async function initialize() {
      statusEl.innerText = 'Status: Initializing TalkingHead';
      try {
        head = new TalkingHead(nodeAvatar, {
          ttsEndpoint: "none",
          lipsyncModules: [],
          lipsyncLang: "en",
          cameraView: "head",
          cameraDistance: 0.9,
          cameraRotateEnable: true
        });

        statusEl.innerText = 'Status: Loading avatar';

        // Resume audio context if blocked
        if (head.audioContext && head.audioContext.state === "suspended") {
          await head.audioContext.resume();
        }

        await head.showAvatar({
          url: "https://models.readyplayer.me/64bfa15f0e72c63d7c3934a6.glb",
          lipsyncLang: "en"
        });

        statusEl.innerText = 'Status: Avatar loaded';
        speakBtn.disabled = false;

        headtts = new HeadTTS();
        headtts.onmessage = (message) => {
          if (message.type === "audio") {
            head.speakAudio(message.data);
          }
        };

      } catch (err) {
        console.error("Initialization error", err);
        statusEl.innerText = "Error: " + (err && err.message ? err.message : String(err));
      }
    }

    initBtn.addEventListener('click', () => {
      initialize();
      initBtn.disabled = true;
    });

    speakBtn.addEventListener('click', () => {
      if (!headtts) return;
      statusEl.innerText = 'Status: Speaking...';
      headtts.synthesize({ input: myPredefinedScript, lang: "en-US" });
    });
  </script>
</body>
</html>
